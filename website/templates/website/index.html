{% extends 'website/base.html' %}
{% load page_fragments %}

{% block content %}
    <div class="container">
        {% get_page_fragment 'welcome' %}
    </div>

    <div class="container-fluid">
        <div id="app">
            <div class="row">
                <div class="col-3 bg-dark text-white shadow">
                    <form>
                        <h4 class="my-3 text-center">Data selection</h4>
                        <div class="form-group row">
                            <label class="col-sm-6 col-form-label" for="speciesSelect">Species:</label>
                            <select class="form-control col-sm-5 form-control-sm" id="speciesSelect" v-model="selectedSpeciesId">
                                <option v-for="species in availableSpecies" :value="species.id">
                                    [[ species.scientific_name ]]
                                </option>
                            </select>
                        </div>

                        <div class="form-group ">
                            <input type="checkbox" id="checkbox-small-squares" v-model="noSmallSquares">
                            <label class="col-form-label col-form-label-sm" for="checkbox-small-squares">Map: show data at 5 or 10km
                                resolution only</label>
                        </div>
                    </form>
                </div>
                <div class="col-9">
                    <div v-if="selectedSpecies">
                        <species-description :species-data="selectedSpecies"></species-description>
                    </div>

                    <h4>Results map</h4>
                    <arabel-map :species-id="selectedSpeciesId" :squares-endpoint="conf.getSquaresDataURL"
                                :no-small-squares="noSmallSquares" />

                </div>
                <div v-if="selectedSpecies">
                    <arabel-table></arabel-table>
                </div>
            </div>
        </div>
    </div>

    <script>
        var arabelConf = {
            availableSpeciesURL: '{% url "available-species-json" %}',
            getSquaresDataURL: '{% url "squares-for-occurrences-json" %}',
        }

        window.onload = function () {
            new Vue({
                el: '#app',
                components: {
                    ArabelMap: ArabelMap,
                    SpeciesDescription: SpeciesDescription,
                    ArabelTable: ArabelTable
                },
                delimiters: ['[[', ']]'],
                data: {
                    selectedSpeciesId: null,
                    noSmallSquares: true,
                    availableSpecies: [],
                    conf: arabelConf
                },
                computed: {
                    selectedSpecies: function () {
                        return (this.selectedSpeciesId ? this.availableSpecies.find(s => s.id == this.selectedSpeciesId) : null)
                    }
                },
                mounted: function () {
                    var vm = this;

                    axios
                        .get(vm.conf.availableSpeciesURL)
                        .then(function (response) {
                            vm.availableSpecies = response.data.species
                        })
                },
            })
        }
    </script>
{% endblock content %}
